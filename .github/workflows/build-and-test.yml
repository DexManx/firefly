name: Build and run tests

on:
  push:
    branches:
      - develop
      - feature/ci
      - test-yarn-cache
  pull_request:
    branches:
      - develop

jobs:
  # backend-node:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - uses: actions/checkout@v2

  #     - name: Set up Node.js
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: 14.x
      
  #     - name: Install Rust stable toolchain
  #       uses: actions-rs/toolchain@v1
  #       with:
  #         toolchain: stable
  #         override: true
  #         profile: minimal

  #     - name: Build Node.js bindings
  #       run: yarn
  #       working-directory: packages/backend/bindings/node
  #       env:
  #         SKIP_POSTINSTALL: 1

  #     - name: Run tests
  #       run: yarn test
  #       working-directory: packages/backend/bindings/node
  #       env:
  #         CARGO_NET_GIT_FETCH_WITH_CLI: true
        
      
  frontend-desktop:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 12.x
    
    - name: Install Rust stable toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
      
    - name: Install required packages
      run: |
        sudo apt update
        sudo apt install gcc-multilib g++-multilib build-essential
    
    - name: Get Yarn cache path and version
      id: yarn-cache
      run: |
        echo "::set-output name=dir::$(yarn cache dir)"
        echo "::set-output name=version::$(basename $(yarn cache dir))"

    - name: Cache Yarn dependencies
      uses: actions/cache@v2
      with:
        path: ${{ steps.yarn-cache.outputs.dir }}
        key: firefly-yarn-${{ steps.yarn-cache.outputs.version }}-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          firefly-yarn-${{ steps.yarn-cache.outputs.version }}-${{ runner.os }}-
    
    - name: Cache cargo target
      uses: actions/cache@v2
      with:
        path: |
          ${{ github.workspace }}/packages/backend/bindings/node/native/target
          ${{ github.workspace }}/packages/backend/bindings/node/native/artifacts.json
        key: firefly-cargo-build-target-backend-bindings-${{ hashFiles(format('{0}{1}', github.workspace, '/packages/backend/bindings/node/native/Cargo.lock')) }}
        restore-keys: |
          firefly-cargo-build-target-backend-bindings-

    
    - name: Install dependencies
      run: yarn
      env: 
          CARGO_NET_GIT_FETCH_WITH_CLI: true
      
    - name: Bundle desktop JS
      run: yarn build
      working-directory: packages/desktop
